<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>CFD Viewer — Axial Data</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://cdn.plot.ly/plotly-2.25.2.min.js"></script>
  <style>
    body { font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, sans-serif; margin: 12px; background:#f7f9fb; color:#122; }
    header { display:flex; align-items:center; gap:12px; }
    h1 { margin:0; font-size:20px; }
    .controls { display:flex; gap:12px; flex-wrap:wrap; margin:10px 0 16px 0; }
    .card { background:white; padding:10px; border-radius:8px; box-shadow:0 6px 18px rgba(20,30,50,0.06); }
    label { font-size:13px; display:block; margin-bottom:6px; color:#334; }
    input[type=file] { display:block; }
    #plot { width:100%; height:640px; }
    .small { font-size:13px; color:#445; }
    .row { display:flex; gap:10px; align-items:center; }
    select, button { padding:6px 8px; border-radius:6px; border:1px solid #d5dce6; background:#fff; }
    .footer { margin-top:10px; font-size:13px; color:#556; }
    pre { background:#0f1724; color:#d8f3ff; padding:8px; border-radius:6px; overflow:auto; }
  </style>
</head>
<body>
  <header>
    <div>
      <h1>CFD Viewer — Axial Data</h1>
      <div class="small">Upload CSV with columns: X/D, AP, TP(PASCAL), MN</div>
    </div>
  </header>

  <div class="controls">
    <div class="card">
      <label>Upload CSV (required)</label>
      <input id="fileInput" type="file" accept=".csv" />
      <div class="small" style="margin-top:8px;">
        Required CSV columns: <code>X/D, AP, TP(PASCAL), MN</code>
      </div>
    </div>

    <div class="card">
      <label>Quantity to plot</label>
      <select id="quantitySelect">
        <option value="absP">Absolute Pressure (AP)</option>
        <option value="totP">Total Pressure (TP in Pascal)</option>
        <option value="mach">Mach Number (MN)</option>
      </select>
    </div>

    <div class="card">
      <label>Examples / Save</label>
      <div class="row">
        <button id="loadExample">Load demo</button>
        <button id="downloadPNG">Export PNG</button>
      </div>
    </div>
  </div>

  <div id="plot" class="card"></div>

  <div class="footer">
    <strong>CSV example format (header):</strong>
    <pre>
X, X/D, AP, TP, TP(PASCAL), MN
0.0,0.0,101325,101325,101325,0.0
0.1,0.1,100000,101300,101300,0.1
0.2,0.2,95000,101200,101200,0.2
...
    </pre>
  </div>

  <script>
  // --- Utilities ---
  function csvToRows(text) {
    const lines = text.split(/\r?\n/).map(l => l.trim()).filter(l => l && !l.startsWith("#"));
    if (lines.length === 0) return {header:[],data:[]};
    const header = lines[0].split(",").map(h=>h.trim());
    const data = lines.slice(1).map(line => {
      const vals = line.split(",").map(s => s.trim());
      const obj = {};
      for (let i=0;i<header.length;i++) obj[header[i]] = parseFloat(vals[i]);
      return obj;
    });
    return { header, data };
  }

  let currentPoints = [];

  function parseUploadedCSV(text) {
    try {
      const { header, data } = csvToRows(text);

      // Expecting headers: X/D, AP, TP(PASCAL), MN
      if (!header.includes("X/D") || !header.includes("AP") ||
          !header.includes("TP(PASCAL)") || !header.includes("MN")) {
        alert("CSV must include: X/D, AP, TP(PASCAL), MN");
        return null;
      }

      const pts = data.map(row => ({
        x: row["X/D"],
        absP: row["AP"],
        totP: row["TP(PASCAL)"],
        mach: row["MN"]
      })).filter(p => Number.isFinite(p.x));

      return pts;
    } catch (e) {
      console.error(e);
      alert("Failed to parse CSV: " + e.message);
      return null;
    }
  }

  async function renderPlot(points, quantity='absP') {
    const yField = (quantity === 'absP') ? points.map(p=>p.absP) :
                   (quantity === 'totP') ? points.map(p=>p.totP) :
                   points.map(p=>p.mach);

    const trace = {
      x: points.map(p=>p.x),
      y: yField,
      mode: 'lines+markers',
      line: { width:2 },
      marker: { size:6, color: yField, colorscale: 'Viridis', showscale: true, colorbar: {title: quantity} },
      hovertemplate: `X/D=%{x}<br>${quantity}=%{y}<extra></extra>`
    };

    const layout = {
      margin: { t:30, r:10, l:50, b:50 },
      showlegend: false,
      xaxis: { title: 'X/D (Axial Distance / Diameter)' },
      yaxis: { title: quantity },
      dragmode: 'pan'
    };

    Plotly.react('plot', [trace], layout, { responsive:true });
  }

  // --- Event handlers ---
  document.getElementById('fileInput').addEventListener('change', async (ev) => {
    const f = ev.target.files[0];
    if (!f) return;
    const text = await f.text();
    const pts = parseUploadedCSV(text);
    if (!pts) return;
    currentPoints = pts;
    renderPlot(currentPoints, document.getElementById('quantitySelect').value);
  });

  document.getElementById('quantitySelect').addEventListener('change', () => {
    if (!currentPoints.length) return;
    renderPlot(currentPoints, document.getElementById('quantitySelect').value);
  });

  document.getElementById('loadExample').addEventListener('click', () => {
    const pts = [];
    for (let i=0;i<=20;i++) {
      const xd = i*0.1;
      pts.push({
        x: xd,
        absP: 101325 - 200*xd,
        totP: 101500 - 150*xd,
        mach: 0.05 + 0.02*i
      });
    }
    currentPoints = pts;
    renderPlot(currentPoints, 'mach');
  });

  document.getElementById('downloadPNG').addEventListener('click', () => {
    Plotly.toImage('plot', {format:'png', height:800, width:1200}).then(dataUrl => {
      const a = document.createElement('a');
      a.href = dataUrl; a.download = 'cfd_axial_plot.png'; document.body.appendChild(a); a.click(); a.remove();
    });
  });

  // Load demo initially
  document.getElementById('loadExample').click();
  </script>
</body>
</html>
